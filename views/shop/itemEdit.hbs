<input type="hidden" id = "collectionId" value={{collectionId}} />
<input type="hidden" id = "itemId" value={{itemId}} />
<style>
    #imageContainer {
        text-align: center;
    }

    .draggable-element {
        display: inline-block;
        width: 120px;
        height: 120px;
        background-color:black;
        border: 1px solid black;
            line-height: 120px;
            text-align: center;
        margin: 10px;
        color: rgb(51, 51, 51);
        font-size: 30px;
        cursor: move;
    }

 
</style>

<script type="text/javascript" src="/javascripts/drag-arrange.js"></script>
<script type="text/javascript">
    const imagePath = "/images/products/";
    var Product = Object.create(null);
    var collectionId = document.getElementById("collectionId").value;
    var itemId = document.getElementById("itemId").value;

    fetchItem = async() => {
        fetch('/item/' + collectionId + '/' + itemId, {
            method: 'POST', // or 'PUT'
            headers: {
                'Content-Type': 'application/json',
            },
                body: JSON.stringify({}),
            })
                .then((response) => response.json())
                .then((data) => {
                    Product = data;
                    renderImageArray(data);
                    renderProperties(data);
            })
            .catch((error) => {
                console.error('ERROR:', error);
        });
    },
    updateItem = async() => {
        $.ajax({
            url: '/updateProduct/' + collectionId + '/' + itemId,
            headers: {"Content-Type": "application/json"},
            type: 'PUT',
            dataType: 'json',
            data: JSON.stringify(Product),
            success: function (data, textStatus, xhr) {
                //console.log(collection.products[0].productThumbs);
                location.href = "/item/" + collectionId + "/" + itemId;
            },
            error: function (xhr, textStatus, errorThrown) {
                console.log('Error in Operation');
                console.log('Error: ' + errorThrown);
            }
        });
    },
    buildImageArray = (element) => {
        var productStringArray = [];
        $(element).children().each(function () {
            const reg = /(?:\(['"]?)(.*?)(?:['"]?\))/;
            const name = reg.exec(this.style.backgroundImage);
            const formattedValue = String(name[1].split(imagePath)).replaceAll(',', '');
            productStringArray.push(formattedValue);
        });
        return productStringArray;
    },
    renderImageArray = (product) => {
        $("#imageContainer").empty();
        Product.item.productThumbs.forEach(o => {
            const imageName = o.split("/");
            $("#imageContainer").append(`<span class="draggable-element d-1" style="background-image: url('${imagePath + o}');background-size:contain;background-repeat:no-repeat;background-position: center;"><button name="${imageName[1]}" type="button" class="btn btn-danger btn-sm" style="float:right" onclick="removeImage(this)">x</button></span>`);
        });

        //Enable the drag
        $('.draggable-element').arrangeable();   
    },
    renderProperties = (product) => {
        $("[name='active']").prop("checked", product.item.active );          
        $("[name='productName']").val(product.item.productName);
        $("[name='productDescription']").val(product.item.description);
        $("[name='size']").val(product.item.size);
        $("[name='price']").val(product.item.price);
        $("[name='measurements']").val(product.item.measurements);
        $("[name='parcel']").val(product.item.ausPostParcel);
    },
    removeImage = (element) => {
        Product.item.productThumbs = Product.item.productThumbs.filter(function(e) { return e !== String(Product.item.productThumbs.filter(name => name.includes(element.name))) })
        renderImageArray(Product); 
    },

    $( document ).ready(async function(){ 
        await fetchItem(); 
        $( "#saveItem").click(async function() {
            Product.item.active = $("[name='active']").val();;
            Product.item.productName = $("[name='productName']").val();
            Product.item.size = $("[name='size']").val();
            Product.item.price = $("[name='price']").val();
            Product.item.description = $("[name='productDescription']").val();
            Product.item.measurements = $("[name='measurements']").val();
            Product.item.ausPostParcel = $("[name='parcel']").val();
            Product.item.productThumbs = buildImageArray('#imageContainer');
            await updateItem();            
        });
    });
</script>

<div class="container">
    <div class="row">
        <div class="col-4">
            <span class="display-5"><strong>Baja Editor</strong></span> 
         </div>
          <div class="col-md-8 text-right clearfix">
            <button id="saveItem" type="button" style="float:right" class="btn btn-outline-warning mt-3">Save</button>   
         </div>
     <hr class="mt-3">
     </div>
    <section class="itemInfo">
        <form class="form-inline">
            <div class="row">
                <div class="col-4">
                    <ul style="list-style-type: none">
                        <li class="baja-font-135 pb-3">Active</li>
                        <li class="baja-font-135 pb-3">Name</li>
                        <li class="baja-font-135 pb-3">Size</li>
                        <li class="baja-font-135 pb-3">Price</li>
                        <li class="baja-font-135 pb-3">Measurements</li>
                    </ul>
                </div>
                <div class="col-7">
                    <ul style="list-style-type: none">
                        <li class="pb-4"><input class="form-check-input"  type="checkbox" name="active"></li>
                        <li class="pb-4"><input name="productName" /></li>
                        <li class="pb-4"><input name="size" /></li>
                        <li class="pb-4"><input name="price" /></li>
                        <li class="pb-4"><textarea class="form-control" name="measurements" rows="1"> </textarea></li>
                    </ul>
                </div>
            </div>
            <div class="row">
                <div class="col-3">
                    <p class="baja-font-135 pb-3 ps-4">Description</p>
                </div>
                <div class="col-7">
                    <textarea class="form-control ms-3" rows="5" name="productDescription" id="productDescription"></textarea>
                </div>
            </div>
        </section>

        <hr />
        <span class="display-6">Image Sorter </span>
        <section class="Image-Gallery">
            <div id="imageContainer"></div>    
        </section>
        <hr />
        <span class="baja-font-135">Parcel Size: </span>
        <select name="parcel" class="form-select form-select-lg" >
            <option value="XS">XS</option>
            <option value="S">S</option>
            <option value="M">M</option>
            <option value="L">L</option>
            <option value="XL">XL</option>
        </select>
        <div class="sizingTable m-3">
            <div class="row bg-primary">
                <div class="col baja-font-larger">Sizing Guide</div>
                <div class="col baja-font-larger">Height</div>
                <div class="col baja-font-larger">Length</div>
                <div class="col baja-font-larger">Width</div>
                <div class="col baja-font-larger">Weight</div>
            </div>
            <div class="row bg-light text-dark">
                <div class="col">XS</div>
                <div class="col">10cm</div>
                <div class="col">26cm</div>
                <div class="col">11cm</div>
                <div class="col">100gms</div>
            </div>
            <div class="row bg-secondary">
                <div class="col">S</div>
                <div class="col">10cm</div>
                <div class="col">34cm</div>
                <div class="col">19cm</div>
                <div class="col">250gms</div>
            </div>
            <div class="row bg-light text-dark">
                <div class="col">M</div>
                <div class="col">10cm</div>
                <div class="col">38cm</div>
                <div class="col">22cm</div>
                <div class="col">500gms</div>
            </div>
            <div class="row bg-secondary">
                <div class="col">L</div>
                <div class="col">10cm</div>
                <div class="col">48cm</div>
                <div class="col">26cm</div>
                <div class="col">700gms</div>
            </div>
            <div class="row bg-light text-dark">
                <div class="col">XL</div>
                <div class="col">10cm</div>
                <div class="col">55cm</div>
                <div class="col">36cm</div>
                <div class="col">1kg</div>
            </div>
            <div class="row bg-secondary">
                <div class="col">XXL</div>
                <div class="col">73cm</div>
                <div class="col">55cm</div>
                <div class="col">36cm</div>
                <div class="col">1.5kg</div>
            </div>
        </div>
    </form>
</div>
